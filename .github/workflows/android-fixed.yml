# ğŸš€ AIç®—å‘½å¤§å¸ˆ - ä¿®å¤ç‰ˆAndroidæ„å»º
name: Build Android APK Fixed

on:
  workflow_dispatch: # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œé¿å…è¿‡å¤šå¤±è´¥
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“± è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ å®‰è£…Node.jsä¾èµ–
      run: npm ci
      
    - name: ğŸ”§ ä½¿ç”¨GitHubé¢„é…ç½®çš„Android SDK
      run: |
        echo "ğŸ”§ ä½¿ç”¨GitHub runneré¢„è£…çš„Android SDK..."
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools" >> $GITHUB_ENV
        
    - name: ğŸ” æ£€æŸ¥Android SDKç¯å¢ƒ
      run: |
        echo "ğŸ“‹ Androidç¯å¢ƒä¿¡æ¯ï¼š"
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "Javaç‰ˆæœ¬:"
        java -version
        echo ""
        echo "ğŸ“‚ æ£€æŸ¥Android SDKç›®å½•ï¼š"
        ls -la "$ANDROID_HOME" || echo "Android SDKç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“‚ æ£€æŸ¥SDKå†…å®¹ï¼š"
        [ -d "$ANDROID_HOME/platforms" ] && ls -la "$ANDROID_HOME/platforms" || echo "platformsç›®å½•ä¸å­˜åœ¨"
        [ -d "$ANDROID_HOME/build-tools" ] && ls -la "$ANDROID_HOME/build-tools" || echo "build-toolsç›®å½•ä¸å­˜åœ¨"
        
    - name: ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        echo "ğŸ“‚ é¡¹ç›®æ ¹ç›®å½•ï¼š"
        ls -la
        echo ""
        echo "ğŸ“‚ Androidé¡¹ç›®ç›®å½•ï¼š"
        if [ -d "android" ]; then
          echo "âœ… androidç›®å½•å­˜åœ¨"
          ls -la android/
          echo ""
          echo "ğŸ“‹ æ£€æŸ¥å…³é”®æ–‡ä»¶ï¼š"
          [ -f "android/gradlew" ] && echo "âœ… gradlewå­˜åœ¨" || echo "âŒ gradlewä¸å­˜åœ¨"
          [ -f "android/build.gradle" ] && echo "âœ… root build.gradleå­˜åœ¨" || echo "âŒ root build.gradleä¸å­˜åœ¨"
          [ -f "android/app/build.gradle" ] && echo "âœ… app build.gradleå­˜åœ¨" || echo "âŒ app build.gradleä¸å­˜åœ¨"
          [ -f "android/gradle.properties" ] && echo "âœ… gradle.propertieså­˜åœ¨" || echo "âŒ gradle.propertiesä¸å­˜åœ¨"
        else
          echo "âŒ androidç›®å½•ä¸å­˜åœ¨ï¼"
          echo "è¿™å¯èƒ½æ˜¯React Nativeé¡¹ç›®é…ç½®é—®é¢˜ã€‚"
        fi
        
    - name: ğŸ› ï¸ å‡†å¤‡Gradleç¯å¢ƒ
      run: |
        if [ -d "android" ] && [ -f "android/gradlew" ]; then
          echo "ğŸ”§ è®¾ç½®gradlewæƒé™..."
          chmod +x android/gradlew
          
          echo "ğŸ“‹ æ£€æŸ¥Gradle Wrapperç‰ˆæœ¬..."
          cd android
          ./gradlew --version || echo "Gradleç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜..."
          ./gradlew clean || echo "æ¸…ç†å¤±è´¥ï¼Œç»§ç»­..."
        else
          echo "âŒ æ— æ³•å‡†å¤‡Gradleç¯å¢ƒï¼šå…³é”®æ–‡ä»¶ç¼ºå¤±"
        fi
        
    - name: ğŸ—ï¸ å°è¯•æ„å»ºAPK
      run: |
        if [ -d "android" ] && [ -f "android/gradlew" ]; then
          echo "ğŸš€ å¼€å§‹æ„å»ºAPK..."
          cd android
          
          echo "ğŸ“‹ åˆ—å‡ºå¯ç”¨çš„æ„å»ºä»»åŠ¡..."
          ./gradlew tasks --group="build" || echo "ä»»åŠ¡åˆ—è¡¨è·å–å¤±è´¥"
          
          echo "ğŸ”¨ å°è¯•æ„å»ºDebug APK..."
          if ./gradlew assembleDebug --no-daemon --stacktrace; then
            echo "âœ… Debug APKæ„å»ºæˆåŠŸï¼"
          else
            echo "âŒ Debug APKæ„å»ºå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
            
            echo "ğŸ”¨ å°è¯•åŸºç¡€æ„å»º..."
            ./gradlew build --no-daemon --stacktrace || {
              echo "âŒ åŸºç¡€æ„å»ºä¹Ÿå¤±è´¥"
              echo "ğŸ“‹ æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯..."
              ./gradlew assembleDebug --debug --stacktrace || true
            }
          fi
        else
          echo "âŒ æ— æ³•æ„å»ºï¼šAndroidé¡¹ç›®é…ç½®ä¸å®Œæ•´"
        fi
        
    - name: ğŸ” æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        echo "ğŸ” æœç´¢æ‰€æœ‰APKæ–‡ä»¶..."
        find . -name "*.apk" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
        echo ""
        echo "ğŸ“‚ æ£€æŸ¥å¸¸è§æ„å»ºè¾“å‡ºç›®å½•..."
        
        if [ -d "android/app/build/outputs/apk" ]; then
          echo "âœ… APKè¾“å‡ºç›®å½•å­˜åœ¨ï¼š"
          find android/app/build/outputs/apk -type f || echo "APKç›®å½•ä¸ºç©º"
        else
          echo "âŒ APKè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
        fi
        
        if [ -d "android/app/build" ]; then
          echo "ğŸ“‚ app/buildç›®å½•å†…å®¹ï¼š"
          ls -la android/app/build/ || echo "æ— æ³•åˆ—å‡ºbuildç›®å½•"
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: android-build-attempt
        path: |
          android/app/build/outputs/apk/**/*.apk
          android/**/build/outputs/apk/**/*.apk
          android/app/build/outputs/bundle/**/*.aab
        if-no-files-found: warn
        
    - name: ğŸ“Š æ„å»ºæŠ¥å‘Š
      run: |
        echo "ğŸ“Š æ„å»ºå°è¯•å®Œæˆ"
        echo "================================"
        
        if find . -name "*.apk" -type f | grep -q .; then
          echo "ğŸ‰ æˆåŠŸï¼šæ‰¾åˆ°APKæ–‡ä»¶ï¼"
          echo "ğŸ“ APKæ–‡ä»¶ä½ç½®ï¼š"
          find . -name "*.apk" -type f
          echo ""
          echo "ğŸŠ æ­å–œï¼æ‚¨çš„AIç®—å‘½å¤§å¸ˆAPKå·²ç”Ÿæˆï¼"
        else
          echo "âŒ APKç”Ÿæˆå¤±è´¥"
          echo ""
          echo "ğŸ’¡ å¤±è´¥å¯èƒ½åŸå› ï¼š"
          echo "1. React Native Androidé¡¹ç›®é…ç½®ä¸å®Œæ•´"
          echo "2. ç¼ºå°‘å¿…è¦çš„Androidä¾èµ–"
          echo "3. Gradleé…ç½®é—®é¢˜"
          echo "4. åŸç”Ÿæ¨¡å—ç¼–è¯‘é—®é¢˜"
          echo ""
          echo "ğŸš€ å»ºè®®è§£å†³æ–¹æ¡ˆï¼š"
          echo "1. ä½¿ç”¨æœ¬åœ°å¼€å‘ç¯å¢ƒæ„å»º"
          echo "2. ä½¿ç”¨Expoæˆ–ç±»ä¼¼æœåŠ¡"
          echo "3. æ£€æŸ¥React Nativeé¡¹ç›®é…ç½®"
          echo "4. ä½¿ç”¨Webç‰ˆæœ¬ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆ"
        fi