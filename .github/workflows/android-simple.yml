# ğŸ“± AIç®—å‘½å¤§å¸ˆ - ç®€åŒ–Androidæ„å»º
name: Build Android APK Simple

on:
  workflow_dispatch: # åªå…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  android-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“± è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ å®‰è£…Node.jsä¾èµ–
      run: npm ci
      
    - name: ğŸ”§ ä½¿ç”¨GitHubé¢„è£…Android SDK
      run: |
        echo "ğŸ“± ä½¿ç”¨GitHubé¢„è£…çš„Android SDK..."
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:/usr/local/lib/android/sdk/platform-tools" >> $GITHUB_ENV
        
    - name: ğŸ” æ£€æŸ¥Androidç¯å¢ƒ
      run: |
        echo "ğŸ” æ£€æŸ¥Android SDKç¯å¢ƒ..."
        echo "ANDROID_HOME: $ANDROID_HOME"
        ls -la $ANDROID_HOME || echo "Android SDKç›®å½•ä¸å­˜åœ¨"
        java -version
        
    - name: ğŸ” æ£€æŸ¥é¡¹ç›®Androidç»“æ„
      run: |
        echo "ğŸ“‚ æ£€æŸ¥Androidé¡¹ç›®ç»“æ„..."
        if [ -d "android" ]; then
          echo "âœ… androidç›®å½•å­˜åœ¨"
          ls -la android/
          
          if [ -f "android/gradlew" ]; then
            echo "âœ… gradlewå­˜åœ¨"
            chmod +x android/gradlew
          else
            echo "âŒ gradlewä¸å­˜åœ¨"
          fi
          
          if [ -f "android/build.gradle" ]; then
            echo "âœ… build.gradleå­˜åœ¨"
          else
            echo "âŒ build.gradleä¸å­˜åœ¨"
          fi
        else
          echo "âŒ androidç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: ğŸ› ï¸ å°è¯•åŸºç¡€Gradleå‘½ä»¤
      working-directory: android
      run: |
        echo "ğŸ”§ å°è¯•åŸºç¡€Gradleå‘½ä»¤..."
        if [ -f "gradlew" ]; then
          echo "ğŸ“‹ æ£€æŸ¥Gradleç‰ˆæœ¬..."
          ./gradlew --version || echo "Gradleç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          
          echo "ğŸ“‹ åˆ—å‡ºå¯ç”¨ä»»åŠ¡..."
          ./gradlew tasks --all || echo "ä»»åŠ¡åˆ—è¡¨è·å–å¤±è´¥"
          
          echo "ğŸ§¹ æ¸…ç†é¡¹ç›®..."
          ./gradlew clean || echo "æ¸…ç†å¤±è´¥"
        else
          echo "âŒ gradlewæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æ„å»º"
        fi
        
    - name: ğŸ¯ ç”Ÿæˆæœ€å°åŒ–APKï¼ˆå¦‚æœå¯èƒ½ï¼‰
      working-directory: android
      run: |
        echo "ğŸ¯ å°è¯•ç”Ÿæˆæœ€å°åŒ–APK..."
        if [ -f "gradlew" ]; then
          echo "ğŸš€ å¼€å§‹æ„å»º..."
          ./gradlew assembleDebug --info --no-daemon || {
            echo "âŒ Debugæ„å»ºå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼..."
            ./gradlew build --info --no-daemon || {
              echo "âŒ æ ‡å‡†æ„å»ºä¹Ÿå¤±è´¥"
              echo "ğŸ“‹ æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯..."
              ./gradlew assembleDebug --debug --stacktrace || true
            }
          }
        else
          echo "âŒ æ— æ³•æ„å»ºï¼šgradlewä¸å­˜åœ¨"
        fi
        
    - name: ğŸ” æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©..."
        find android -name "*.apk" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
        echo "ğŸ“‚ æ£€æŸ¥å¯èƒ½çš„è¾“å‡ºç›®å½•..."
        [ -d "android/app/build/outputs" ] && ls -la android/app/build/outputs/ || echo "outputsç›®å½•ä¸å­˜åœ¨"
        [ -d "android/app/build/outputs/apk" ] && ls -la android/app/build/outputs/apk/ || echo "apkç›®å½•ä¸å­˜åœ¨"
        
    - name: ğŸ“¤ ä¸Šä¼ ä»»ä½•æ‰¾åˆ°çš„APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-attempt
        path: |
          android/app/build/outputs/apk/**/*.apk
          android/**/build/outputs/apk/**/*.apk
        if-no-files-found: warn
        
    - name: ğŸ“Š æ„å»ºæŠ¥å‘Š
      run: |
        echo "ğŸ“Š Androidæ„å»ºå°è¯•å®Œæˆ"
        echo ""
        if find android -name "*.apk" -type f | grep -q .; then
          echo "ğŸ‰ æˆåŠŸï¼šæ‰¾åˆ°APKæ–‡ä»¶ï¼"
          find android -name "*.apk" -type f
        else
          echo "âŒ å¤±è´¥ï¼šæœªç”ŸæˆAPKæ–‡ä»¶"
          echo ""
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š"
          echo "1. React Nativeé¡¹ç›®éœ€è¦å®Œæ•´çš„Androidå¼€å‘ç¯å¢ƒ"
          echo "2. ç¼ºå°‘React NativeåŸç”Ÿæ¨¡å—é…ç½®"
          echo "3. Gradleé…ç½®é—®é¢˜"
          echo "4. Android SDKé…ç½®é—®é¢˜"
          echo ""
          echo "ğŸš€ å»ºè®®ï¼šä½¿ç”¨ä¸“é—¨çš„React Nativeæ„å»ºActionæˆ–æœ¬åœ°ç¯å¢ƒ"
        fi