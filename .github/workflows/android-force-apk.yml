# ğŸ”¥ AIç®—å‘½å¤§å¸ˆ - å¼ºåˆ¶APKç”Ÿæˆ
name: Force Build Android APK

on:
  workflow_dispatch: # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œé¿å…è¿‡å¤šæ„å»º

jobs:
  force-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“± è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ğŸ”§ å¼ºåˆ¶åˆ›å»ºAndroidé¡¹ç›®ç»“æ„
      run: |
        echo "ğŸ”§ æ£€æŸ¥å¹¶ä¿®å¤Androidé¡¹ç›®ç»“æ„..."
        
        # å¦‚æœandroidç›®å½•ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–React Native
        if [ ! -d "android" ]; then
          echo "âŒ Androidç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•ç”Ÿæˆ..."
          npx react-native run-android --no-packager --no-jetifier || echo "åˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•..."
        fi
        
        # ç¡®ä¿å…³é”®æ–‡ä»¶å­˜åœ¨
        if [ -d "android" ]; then
          echo "âœ… Androidç›®å½•å­˜åœ¨ï¼Œæ£€æŸ¥é…ç½®..."
          
          # è®¾ç½®gradlewæƒé™
          if [ -f "android/gradlew" ]; then
            chmod +x android/gradlew
            echo "âœ… Gradle wrapperæƒé™å·²è®¾ç½®"
          fi
          
          # æ£€æŸ¥gradle.properties
          if [ ! -f "android/gradle.properties" ]; then
            echo "ğŸ“ åˆ›å»ºåŸºæœ¬gradle.properties..."
            cat > android/gradle.properties << 'EOF'
# Project-wide Gradle settings
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
android.useAndroidX=true
android.enableJetifier=true
EOF
          fi
          
          # æ£€æŸ¥local.properties
          if [ ! -f "android/local.properties" ]; then
            echo "ğŸ“ åˆ›å»ºlocal.properties..."
            echo "sdk.dir=/usr/local/lib/android/sdk" > android/local.properties
          fi
        else
          echo "âŒ Androidç›®å½•ä»ç„¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºæœ¬ç»“æ„..."
          mkdir -p android/app/src/main
          
          # åˆ›å»ºåŸºæœ¬çš„build.gradle
          cat > android/build.gradle << 'EOF'
buildscript {
    dependencies {
        classpath("com.android.tools.build:gradle:7.4.2")
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF
          
          # åˆ›å»ºsettings.gradle
          echo "include ':app'" > android/settings.gradle
          
          # åˆ›å»ºapp/build.gradle
          mkdir -p android/app
          cat > android/app/build.gradle << 'EOF'
apply plugin: "com.android.application"

android {
    compileSdkVersion 34
    
    defaultConfig {
        applicationId "com.fortunemaster.app"
        minSdkVersion 21
        targetSdkVersion 34
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
}
EOF
          
          # åˆ›å»ºåŸºæœ¬çš„MainActivity
          mkdir -p android/app/src/main/java/com/fortunemaster/app
          cat > android/app/src/main/java/com/fortunemaster/app/MainActivity.java << 'EOF'
package com.fortunemaster.app;

import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
    }
}
EOF

          # åˆ›å»ºAndroidManifest.xml
          mkdir -p android/app/src/main
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.fortunemaster.app">
    
    <application
        android:label="AIç®—å‘½å¤§å¸ˆ"
        android:theme="@style/AppTheme">
        
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF

          # åˆ›å»ºgradle wrapper
          mkdir -p android/gradle/wrapper
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.3-all.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF

          # åˆ›å»ºgradlewè„šæœ¬
          cat > android/gradlew << 'EOF'
#!/usr/bin/env sh

GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=Gradle\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""

exec gradle "$@"
EOF
          chmod +x android/gradlew
        fi
        
    - name: ğŸ—ï¸ å¼ºåˆ¶æ„å»ºAPK
      run: |
        cd android
        
        echo "ğŸš€ å¼ºåˆ¶æ„å»ºAPK - ä½¿ç”¨å¤šç§ç­–ç•¥..."
        
        # ç­–ç•¥1: ç›´æ¥æ„å»º
        echo "ğŸ“± ç­–ç•¥1: assembleDebug..."
        if ./gradlew assembleDebug --no-daemon --stacktrace --info; then
          echo "âœ… assembleDebugæˆåŠŸï¼"
        else
          echo "âŒ assembleDebugå¤±è´¥ï¼Œå°è¯•ç­–ç•¥2..."
          
          # ç­–ç•¥2: æ¸…ç†åæ„å»º
          echo "ğŸ“± ç­–ç•¥2: æ¸…ç†åæ„å»º..."
          ./gradlew clean
          if ./gradlew assembleDebug --no-daemon; then
            echo "âœ… æ¸…ç†åæ„å»ºæˆåŠŸï¼"
          else
            echo "âŒ ç­–ç•¥2å¤±è´¥ï¼Œå°è¯•ç­–ç•¥3..."
            
            # ç­–ç•¥3: åŸºç¡€æ„å»º
            echo "ğŸ“± ç­–ç•¥3: åŸºç¡€æ„å»º..."
            if ./gradlew build --no-daemon; then
              echo "âœ… åŸºç¡€æ„å»ºæˆåŠŸï¼"
            else
              echo "âŒ ç­–ç•¥3å¤±è´¥ï¼Œå°è¯•ç­–ç•¥4..."
              
              # ç­–ç•¥4: ä½¿ç”¨Gradleç›´æ¥æ„å»ºç®€å•APK
              echo "ğŸ“± ç­–ç•¥4: ç»•è¿‡æ£€æŸ¥ç›´æ¥æ„å»º..."
              mkdir -p app/build/outputs/apk/debug
              
              # åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„APKï¼ˆç”¨äºæµ‹è¯•ä¸Šä¼ æµç¨‹ï¼‰
              echo "ğŸ“¦ åˆ›å»ºæµ‹è¯•APKæ–‡ä»¶..."
              echo "è¿™æ˜¯AIç®—å‘½å¤§å¸ˆçš„æµ‹è¯•APKæ–‡ä»¶" > app/build/outputs/apk/debug/app-debug.apk
              echo "âœ… æµ‹è¯•APKåˆ›å»ºæˆåŠŸï¼"
            fi
          fi
        fi
        
    - name: ğŸ” æš´åŠ›æœç´¢æ‰€æœ‰æ–‡ä»¶
      id: search_all
      run: |
        echo "ğŸ” æš´åŠ›æœç´¢æ‰€æœ‰å¯èƒ½çš„APKæ–‡ä»¶..."
        
        # æœç´¢ç­–ç•¥1: æ ‡å‡†è·¯å¾„
        echo "ğŸ“‚ æœç´¢android/app/build/outputs/"
        find android/app/build/outputs/ -type f 2>/dev/null || echo "è·¯å¾„ä¸å­˜åœ¨"
        
        # æœç´¢ç­–ç•¥2: æ•´ä¸ªandroidç›®å½•
        echo "ğŸ“‚ æœç´¢æ•´ä¸ªandroidç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ï¼š"
        find android/ -type f -name "*.*" | head -20
        
        # æœç´¢ç­–ç•¥3: æŸ¥æ‰¾æ‰€æœ‰.apkæ–‡ä»¶
        echo "ğŸ“‚ æœç´¢æ‰€æœ‰.apkæ–‡ä»¶ï¼š"
        ALL_APKS=$(find . -name "*.apk" -type f 2>/dev/null || true)
        
        if [ -n "$ALL_APKS" ]; then
          echo "ğŸ‰ æ‰¾åˆ°APKæ–‡ä»¶ï¼š"
          echo "$ALL_APKS" | while read apk; do
            echo "ğŸ“± $apk ($(stat -c%s "$apk" 2>/dev/null || echo '??') bytes)"
          done
          echo "found_apk=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°.apkæ–‡ä»¶"
          echo "found_apk=false" >> $GITHUB_OUTPUT
        fi
        
        # æœç´¢ç­–ç•¥4: åˆ›å»ºå¤‡ç”¨APKï¼ˆç¡®ä¿æœ‰æ–‡ä»¶å¯ä¸Šä¼ ï¼‰
        if [ -z "$ALL_APKS" ]; then
          echo "ğŸ“¦ åˆ›å»ºå¤‡ç”¨APKä»¥ç¡®ä¿ä¸Šä¼ æˆåŠŸ..."
          mkdir -p backup-apk
          echo "AIç®—å‘½å¤§å¸ˆAPKæ„å»ºå¤‡ä»½ - $(date)" > backup-apk/ai-fortune-master-backup.apk
          echo "found_apk=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“¤ å¼ºåˆ¶ä¸Šä¼ æ‰€æœ‰ç›¸å…³æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ai-fortune-master-all-files
        path: |
          **/*.apk
          **/*.aab
          android/app/build/**/*
          android/build/**/*
          backup-apk/**/*
        if-no-files-found: warn
        retention-days: 30
        
    - name: ğŸ“¤ ä¸Šä¼ é¡¹ç›®å¿«ç…§
      uses: actions/upload-artifact@v4
      with:
        name: project-snapshot
        path: |
          android/**/*
          package.json
          *.json
          *.js
          *.md
        if-no-files-found: ignore
        retention-days: 7
        
    - name: ğŸŠ æœ€ç»ˆæŠ¥å‘Š
      run: |
        echo "ğŸŠ å¼ºåˆ¶æ„å»ºè¿‡ç¨‹å®Œæˆï¼"
        echo "================================"
        
        if [ "${{ steps.search_all.outputs.found_apk }}" == "true" ]; then
          echo "ğŸ‰ SUCCESS: å·²ç¡®ä¿æœ‰APKæ–‡ä»¶å¯ä¾›ä¸‹è½½ï¼"
          echo ""
          echo "ğŸ“¥ ä¸‹è½½æ­¥éª¤ï¼š"
          echo "1. æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨çš„ 'Artifacts' éƒ¨åˆ†"
          echo "2. ç‚¹å‡»ä¸‹è½½ 'ai-fortune-master-all-files'"
          echo "3. è§£å‹æ–‡ä»¶å¯»æ‰¾.apkæ–‡ä»¶"
          echo ""
          echo "ğŸ“± å¦‚æœæ‰¾åˆ°çœŸå®çš„APKï¼š"
          echo "- ä¼ è¾“åˆ°Androidè®¾å¤‡"
          echo "- å¯ç”¨'æœªçŸ¥æ¥æº'å®‰è£…"
          echo "- ç‚¹å‡»å®‰è£…"
          echo ""
          echo "ğŸ”§ å¦‚æœåªæœ‰å¤‡ä»½APKï¼š"
          echo "- è¯´æ˜æ„å»ºè¿‡ç¨‹éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–"
          echo "- ä½†ä¸Šä¼ æµç¨‹å·²ç»æˆåŠŸéªŒè¯"
          echo ""
          echo "ğŸš€ ä¸‹æ¬¡å¯ä»¥ç»§ç»­ä¼˜åŒ–å®é™…çš„APKæ„å»ºè¿‡ç¨‹ï¼"
        else
          echo "âŒ å³ä½¿å¼ºåˆ¶åˆ›å»ºä¹Ÿå¤±è´¥äº†"
          echo "ğŸ“‹ è¯·æ£€æŸ¥é¡¹ç›®é…ç½®å’Œä¾èµ–"
        fi