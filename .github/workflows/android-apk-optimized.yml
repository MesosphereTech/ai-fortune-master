# ğŸš€ AIç®—å‘½å¤§å¸ˆ - ä¼˜åŒ–APKæ„å»ºå’Œä¸Šä¼ 
name: Build Android APK Optimized

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“± è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ å®‰è£…Node.jsä¾èµ–
      run: npm ci
      
    - name: ğŸ”§ è®¾ç½®Androidç¯å¢ƒ
      run: |
        echo "ğŸ”§ é…ç½®Android SDKç¯å¢ƒ..."
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools" >> $GITHUB_ENV
        
    - name: ğŸ” é¡¹ç›®ç»“æ„è¯Šæ–­
      run: |
        echo "ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„..."
        echo "ğŸ“‚ é¡¹ç›®æ ¹ç›®å½•ï¼š"
        ls -la
        echo ""
        echo "ğŸ“‚ æ£€æŸ¥React Nativeé…ç½®ï¼š"
        [ -f "react-native.config.js" ] && echo "âœ… react-native.config.jså­˜åœ¨" || echo "âŒ react-native.config.jsä¸å­˜åœ¨"
        [ -f "metro.config.js" ] && echo "âœ… metro.config.jså­˜åœ¨" || echo "âŒ metro.config.jsä¸å­˜åœ¨"
        [ -f "app.json" ] && echo "âœ… app.jsonå­˜åœ¨" || echo "âŒ app.jsonä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“‚ Androidé¡¹ç›®æ£€æŸ¥ï¼š"
        if [ -d "android" ]; then
          echo "âœ… Androidç›®å½•å­˜åœ¨"
          ls -la android/
          echo ""
          echo "ğŸ“‹ Androidé…ç½®æ–‡ä»¶ï¼š"
          [ -f "android/build.gradle" ] && echo "âœ… android/build.gradleå­˜åœ¨" || echo "âŒ android/build.gradleä¸å­˜åœ¨"
          [ -f "android/settings.gradle" ] && echo "âœ… android/settings.gradleå­˜åœ¨" || echo "âŒ android/settings.gradleä¸å­˜åœ¨"
          [ -f "android/gradle.properties" ] && echo "âœ… android/gradle.propertieså­˜åœ¨" || echo "âŒ android/gradle.propertiesä¸å­˜åœ¨"
          [ -f "android/gradlew" ] && echo "âœ… android/gradlewå­˜åœ¨" || echo "âŒ android/gradlewä¸å­˜åœ¨"
          echo ""
          if [ -d "android/app" ]; then
            echo "âœ… android/appç›®å½•å­˜åœ¨"
            [ -f "android/app/build.gradle" ] && echo "âœ… android/app/build.gradleå­˜åœ¨" || echo "âŒ android/app/build.gradleä¸å­˜åœ¨"
          else
            echo "âŒ android/appç›®å½•ä¸å­˜åœ¨"
          fi
        else
          echo "âŒ Androidç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: ğŸ› ï¸ å‡†å¤‡Androidæ„å»ºç¯å¢ƒ
      run: |
        if [ -d "android" ] && [ -f "android/gradlew" ]; then
          echo "ğŸ› ï¸ è®¾ç½®Gradleæƒé™..."
          chmod +x android/gradlew
          
          echo "ğŸ“‹ æ£€æŸ¥Gradle Wrapper..."
          cd android
          ./gradlew --version
          
          echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»º..."
          ./gradlew clean
        else
          echo "âŒ Androidé¡¹ç›®é…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•æ„å»ºAPK"
          exit 1
        fi
        
    - name: ğŸ—ï¸ æ„å»ºAndroid APKï¼ˆå¤šç§æ–¹å¼ï¼‰
      run: |
        cd android
        
        echo "ğŸš€ æ–¹å¼1: å°è¯•æ„å»ºRelease APK..."
        if ./gradlew assembleRelease --no-daemon --stacktrace; then
          echo "âœ… Release APKæ„å»ºæˆåŠŸï¼"
        else
          echo "âŒ Release APKæ„å»ºå¤±è´¥ï¼Œå°è¯•Debugç‰ˆæœ¬..."
          
          echo "ğŸš€ æ–¹å¼2: å°è¯•æ„å»ºDebug APK..."
          if ./gradlew assembleDebug --no-daemon --stacktrace; then
            echo "âœ… Debug APKæ„å»ºæˆåŠŸï¼"
          else
            echo "âŒ Debug APKä¹Ÿå¤±è´¥ï¼Œå°è¯•åŸºç¡€æ„å»º..."
            
            echo "ğŸš€ æ–¹å¼3: å°è¯•åŸºç¡€æ„å»º..."
            if ./gradlew build --no-daemon --stacktrace; then
              echo "âœ… åŸºç¡€æ„å»ºæˆåŠŸï¼"
            else
              echo "âŒ æ‰€æœ‰æ„å»ºæ–¹å¼éƒ½å¤±è´¥äº†"
              echo "ğŸ“‹ æ˜¾ç¤ºè¯¦ç»†é”™è¯¯..."
              ./gradlew assembleDebug --info --stacktrace || true
            fi
          fi
        fi
        
    - name: ğŸ” å…¨é¢æœç´¢APKæ–‡ä»¶
      id: find_apks
      run: |
        echo "ğŸ” å¼€å§‹å…¨é¢æœç´¢APKæ–‡ä»¶..."
        echo ""
        
        # æœç´¢æ‰€æœ‰å¯èƒ½çš„APKä½ç½®
        echo "ğŸ“‚ æœç´¢èŒƒå›´1: android/app/build/outputs/"
        find android/app/build/outputs/ -name "*.apk" -type f 2>/dev/null || echo "æ­¤è·¯å¾„ä¸‹æ— APKæ–‡ä»¶"
        
        echo ""
        echo "ğŸ“‚ æœç´¢èŒƒå›´2: android/build/outputs/"
        find android/build/outputs/ -name "*.apk" -type f 2>/dev/null || echo "æ­¤è·¯å¾„ä¸‹æ— APKæ–‡ä»¶"
        
        echo ""
        echo "ğŸ“‚ æœç´¢èŒƒå›´3: æ•´ä¸ªandroidç›®å½•"
        find android/ -name "*.apk" -type f 2>/dev/null || echo "æ•´ä¸ªandroidç›®å½•ä¸‹æ— APKæ–‡ä»¶"
        
        echo ""
        echo "ğŸ“‚ æœç´¢èŒƒå›´4: æ•´ä¸ªé¡¹ç›®"
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null || true)
        
        if [ -n "$APK_FILES" ]; then
          echo "ğŸ‰ æ‰¾åˆ°APKæ–‡ä»¶ï¼"
          echo "$APK_FILES"
          echo ""
          echo "ğŸ“Š APKæ–‡ä»¶è¯¦æƒ…ï¼š"
          for apk in $APK_FILES; do
            echo "ğŸ“± $apk"
            ls -lh "$apk"
            echo ""
          done
          echo "has_apk=true" >> $GITHUB_OUTPUT
          echo "apk_files<<EOF" >> $GITHUB_OUTPUT
          echo "$APK_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•APKæ–‡ä»¶"
          echo "has_apk=false" >> $GITHUB_OUTPUT
        fi
        
        # åŒæ—¶æœç´¢AABæ–‡ä»¶
        echo ""
        echo "ğŸ” æœç´¢AABæ–‡ä»¶..."
        AAB_FILES=$(find . -name "*.aab" -type f 2>/dev/null || true)
        if [ -n "$AAB_FILES" ]; then
          echo "ğŸ“¦ æ‰¾åˆ°AABæ–‡ä»¶ï¼"
          echo "$AAB_FILES"
          echo "has_aab=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ æœªæ‰¾åˆ°AABæ–‡ä»¶"
          echo "has_aab=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ APKæ–‡ä»¶
      if: steps.find_apks.outputs.has_apk == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ai-fortune-master-apk
        path: |
          **/*.apk
          **/*.aab
        if-no-files-found: warn
        retention-days: 30
        
    - name: ğŸ“¤ ä¸Šä¼ è¯¦ç»†æ„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          android/build/reports/**/*
          android/app/build/reports/**/*
          android/gradle.properties
          android/local.properties
        if-no-files-found: ignore
        retention-days: 7
        
    - name: ğŸŠ æ„å»ºç»“æœæŠ¥å‘Š
      run: |
        echo "ğŸŠ æ„å»ºè¿‡ç¨‹å®Œæˆï¼"
        echo "================================"
        
        if [ "${{ steps.find_apks.outputs.has_apk }}" == "true" ]; then
          echo "ğŸ‰ SUCCESS: APKæ„å»ºæˆåŠŸï¼"
          echo ""
          echo "ğŸ“± ç”Ÿæˆçš„APKæ–‡ä»¶ï¼š"
          echo "${{ steps.find_apks.outputs.apk_files }}"
          echo ""
          echo "ğŸ“¥ ä¸‹è½½æ–¹å¼ï¼š"
          echo "1. è®¿é—®æ­¤æ„å»ºçš„Artifactséƒ¨åˆ†"
          echo "2. ä¸‹è½½ 'ai-fortune-master-apk' æ–‡ä»¶"
          echo "3. è§£å‹åè·å¾—APKæ–‡ä»¶"
          echo ""
          echo "ğŸ“± å®‰è£…æ–¹å¼ï¼š"
          echo "1. å¯ç”¨Androidè®¾å¤‡çš„"æœªçŸ¥æ¥æº"å®‰è£…"
          echo "2. å°†APKæ–‡ä»¶ä¼ è¾“åˆ°Androidè®¾å¤‡"
          echo "3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…"
          echo ""
          echo "ğŸŠ æ­å–œï¼æ‚¨çš„AIç®—å‘½å¤§å¸ˆåº”ç”¨å·²å‡†å¤‡å°±ç»ªï¼"
        else
          echo "âŒ APKæ„å»ºå¤±è´¥"
          echo ""
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š"
          echo "1. React Native Androidé…ç½®ä¸å®Œæ•´"
          echo "2. ä¾èµ–åŒ…æœ‰é—®é¢˜"
          echo "3. Gradleé…ç½®é”™è¯¯"
          echo "4. Java/Android SDKç‰ˆæœ¬ä¸å…¼å®¹"
          echo ""
          echo "ğŸ”§ å»ºè®®è§£å†³æ–¹æ¡ˆï¼š"
          echo "1. æ£€æŸ¥package.jsonä¸­çš„ä¾èµ–"
          echo "2. ç¡®ä¿android/ç›®å½•é…ç½®æ­£ç¡®"
          echo "3. ä½¿ç”¨Webç‰ˆæœ¬ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆ"
          echo "4. æœ¬åœ°ç¯å¢ƒæµ‹è¯•æ„å»ºè¿‡ç¨‹"
        fi
        
        if [ "${{ steps.find_apks.outputs.has_aab }}" == "true" ]; then
          echo ""
          echo "ğŸ“¦ åŒæ—¶ç”Ÿæˆäº†AABæ–‡ä»¶ï¼ˆGoogle Play Bundleæ ¼å¼ï¼‰"
        fi